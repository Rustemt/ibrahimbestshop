SELECT
    a.IND AS CARHARIND,
    a.FIRMANO,
    a.BORC,
    a.ALACAK,
    (SELECT DBO.ROUNDYTL(SUM(BORC-ALACAK))
    FROM *!F!DTBLCARIHAREKETLERI WHERE SIRALAMATARIHI<=A.SIRALAMATARIHI AND FIRMANO=A.FIRMANO ) AS BAKIYE,
    a.BORC/(CASE WHEN ISNULL(A.KUR,1)=0 THEN 1 ELSE A.KUR END) AS DOVIZBORC,
    a.ALACAK/(CASE WHEN ISNULL(A.KUR,1)=0 THEN 1 ELSE A.KUR END) AS DOVIZALACAK,
    (SELECT DBO.ROUNDYTL(SUM((BORC-ALACAK)/CASE WHEN ISNULL(KUR,1)=0 THEN 1 ELSE KUR END))
    FROM *!F!DTBLCARIHAREKETLERI WHERE PARABIRIMI=A.PARABIRIMI
    AND SIRALAMATARIHI<=A.SIRALAMATARIHI AND FIRMANO=A.FIRMANO ) AS DOVIZBAKIYE,

        (SELECT DBO.ROUNDYTL(SUM(K.BORC)) FROM *!F!DTBLCARIHAREKETLERI AS K WHERE
    K.SIRALAMATARIHI<DTARIH AND K.FIRMANO=a.FIRMANO ) AS DEVREDENBORCTUTARI,

    (SELECT DBO.ROUNDYTL(SUM(K.ALACAK)) FROM *!F!DTBLCARIHAREKETLERI AS K WHERE
    K.SIRALAMATARIHI<DTARIH AND K.FIRMANO=a.FIRMANO ) AS DEVREDENALACAKTUTARI,

    (SELECT DBO.ROUNDYTL(SUM((BORC-ALACAK)/CASE WHEN ISNULL(KUR,1)=0 THEN 1 ELSE KUR END))
    FROM *!F!DTBLCARIGENELHAREKET WHERE PARABIRIMI='$'
    AND SIRALAMATARIHI<=A.SIRALAMATARIHI AND FIRMANO=A.FIRMANO ) AS HARDOVIZBAKIYE,

    (SELECT DBO.ROUNDYTL(SUM((BORC-ALACAK)/CASE WHEN ISNULL(KUR,1)=0 THEN 1 ELSE KUR END))
    FROM *!F!DTBLCARIGENELHAREKET WHERE PARABIRIMI='€'
    AND SIRALAMATARIHI<=A.SIRALAMATARIHI AND FIRMANO=A.FIRMANO ) AS HAREURODOVIZBAKIYE,

    (SELECT DBO.ROUNDYTL(SUM(K.BORC)) FROM *!F!DTBLCARIHAREKETLERI AS K WHERE
    K.SIRALAMATARIHI<=a.SIRALAMATARIHI AND K.TARIH<a.TARIH AND K.FIRMANO=a.FIRMANO ) AS DEVREDENBORC,

    (SELECT DBO.ROUNDYTL(SUM(K.ALACAK)) FROM *!F!DTBLCARIHAREKETLERI AS K WHERE
    K.SIRALAMATARIHI<=A.SIRALAMATARIHI AND K.TARIH<a.TARIH AND K.FIRMANO=a.FIRMANO ) AS DEVREDENALACAK,

    (SELECT DBO.ROUNDYTL(SUM((K.BORC)-(K.ALACAK))) FROM *!F!DTBLCARIHAREKETLERI AS K WHERE
    K.SIRALAMATARIHI<=a.SIRALAMATARIHI AND K.TARIH<A.TARIH AND K.FIRMANO=a.FIRMANO ) AS DEVREDENBAKIYE,

    (SELECT DBO.ROUNDYTL(SUM((BORC-ALACAK)/CASE WHEN ISNULL(KUR,1)=0 THEN 1 ELSE KUR END)) FROM *!F!DTBLCARIHAREKETLERI WHERE PARABIRIMI=a.PARABIRIMI
    AND SIRALAMATARIHI<=a.SIRALAMATARIHI AND TARIH<a.TARIH AND FIRMANO=a.FIRMANO ) AS DEVREDENDOVIZBAKIYE,
    (SELECT SUM((K.BORC)-(K.ALACAK)) FROM *!F!DTBLCARIHAREKETLERI AS K WHERE
    K.FIRMANO=A.FIRMANO ) AS SONBAKIYE,
    CR.IND,
    CR.FIRMAKODU,
    CR.EMAIL,
    CR.FIRMAADI+' | '+CR.FIRMAKODU AS FIRMAADI,
    a.TARIH,
    dbo.IZAHATTOSTR(a.IZAHAT) as 'IZAHAT',
    a.EVRAKNO,
    a.PARABIRIMI,
    a.KUR,
    a.LN,
    a.SIRALAMATARIHI,
    BASLIK.OZELKOD1 AS BASLIKOZELKOD1,
    BASLIK.OZELKOD2 AS BASLIKOZELKOD2,
    BASLIK.OZELKOD3 AS BASLIKOZELKOD3,
    BASLIK.OZELKOD4 AS BASLIKOZELKOD4,
    BASLIK.OZELKOD5 AS BASLIKOZELKOD5,
    BASLIK.OZELKOD6 AS BASLIKOZELKOD6,
    BASLIK.OZELKOD7 AS BASLIKOZELKOD7,
    BASLIK.OZELKOD8 AS BASLIKOZELKOD8,
    BASLIK.BASLIKACIKLAMA
    FROM *!F!DTBLCARIHAREKETLERI as a
    LEFT JOIN *!F!DVBASLIKLAR AS BASLIK ON
    BASLIK.FIRMANO=a.FIRMANO AND BASLIK.IND=a.LN AND a.IZAHAT=BASLIK.BELGETIPI
    LEFT JOIN *!FTBLCARI AS CR ON
    CR.IND=A.FIRMANO
    [WHERE] A.FIRMANO >= 100 AND A.IZAHAT NOT IN (18,19) AND 1=1 AND CR.FIRMATIPI NOT IN (11) AND  FIRMAKODU='[FIRMAKODU]' 
    GROUP BY
    a.IND,
    a.FIRMANO,
    a.TARIH,
    a.IZAHAT,
    a.EVRAKNO,
    a.BORC,
    a.ALACAK,
    a.PARABIRIMI,
    a.KUR,
    a.LN,
    a.SIRALAMATARIHI,
    BASLIK.OZELKOD1,
    BASLIK.OZELKOD2,
    BASLIK.OZELKOD3,
    BASLIK.OZELKOD4,
    BASLIK.OZELKOD5,
    BASLIK.OZELKOD6,
    BASLIK.OZELKOD7,
    BASLIK.OZELKOD8,
    BASLIK.BASLIKACIKLAMA,
    CR.EMAIL,
    CR.IND,
    CR.FIRMAKODU,
    CR.FIRMAADI
    ORDER BY
    a.SIRALAMATARIHI


